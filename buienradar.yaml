rest:
  - resource: https://gadgets.buienradar.nl/data/raintext
    scan_interval: 300
    # timeout: 30 # timeout for ipv6 delays, seems no longer needed
    params:
      lat: "{{'%.2f' | format(state_attr('zone.home', 'latitude') | float(0))}}"
      lon: "{{'%.2f' | format(state_attr('zone.home', 'longitude') | float(0))}}"
    headers:
      cache-control: "no-cache"
    sensor:
      - name: "Buienradar api"
        unique_id: buienradar_api
        value_template: "{{ value }}"
        availability: "{{ value is defined and value|length>100 }}"

template:
  - triggers:
      - trigger: state
        entity_id: sensor.buienradar_api
        not_to:
          - unavailable
          - unknown
    conditions:
      condition: template
      value_template: "{{ has_value('sensor.buienradar_api')}}"
    variables:
      precip: >-
          {%- set ns = namespace(start="", precip=[]) %}
          {%- for l in states("sensor.buienradar_api").split("\n") %}
            {%- if l|length > 0 %}
              {%- set v = l.split("|") %}
              {%- set ns.precip = ns.precip + [ (10**((v[0]|int(0)-109)/32))|round(1) ] %}
            {%- endif %}
          {%- endfor %}
          {{ns.precip}}

    sensor:
      - name: "Buienradar precipitation"
        unique_id: buienradar_precepitation
        # only update when call succeeded
        state: >-
          {{ precip[0:1]|max }}
        device_class: precipitation_intensity
        unit_of_measurement: "mm/h"
        attributes:
          precip: "{{precip}}"
          start: >-
            {% set t = states("sensor.buienradar_api")[4:9].split(":") %}
            {{now().replace(hour=t[0]|int(0),minute=t[1]|int(0),second=0,microsecond=0)|as_timestamp}}
          delta: 300
    binary_sensor:
      - name: "Buienradar expected"
        unique_id: buienradar_expected
        state: >-
          {{precip[2:6]|sum>0.3 }}
